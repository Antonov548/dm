---
title: "Zooming and manipulating tables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Zooming and manipulating tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(dm)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
fansi::set_knit_hooks(knitr::knit_hooks)
options(crayon.enabled = TRUE, width = 75, cli.width = 75)

knit_print.grViz <- function(x, ...) {
  x %>% 
    DiagrammeRsvg::export_svg() %>% 
    c("`````{=html}\n", ., "\n`````\n") %>% 
    knitr::asis_output()
}
```

Among others, this vignette covers how to deal with the following situation: You have a `dm` with a set of tables and their relations.
Now you would like to include another table which is based on one or more of those tables, maybe a summary of sorts.
There are two straightforward solutions to the problem:
1. individually access the tables relevant for the calculation, perform the necessary transformations and then add the result to the `dm`.
1. do all this within the `dm` object by zooming to a table and manipulate it while maintaining the key relations whenever possible.

The first approach is rather self-explanatory, so let us have a closer look at the second way.

## Enabling {dplyr}-workflow within a `dm`

Some general information about "zooming" to a table of a `dm`:
- all information stored in the original `dm` is kept, including the originally zoomed table
- an object of class `zoomed_dm` is produced
- a copy of the original table is available for transformations

{dm} provides methods for many of the {dplyr}-verbs for a `zoomed_dm` which behave the way you are used to, affecting only the zoomed table and leaving the rest of the `dm` untouched.
When you are finished with transforming the table, there are three ways to proceed:
1. use `cdm_update_zoomed_tbl()` if you want to replace the originally zoomed table with the new table
1. with `cdm_insert_zoomed_tbl()` you are creating a new table for your `dm`
1. use `cdm_zoom_out()` if you do not need the result and want to discard it

When employing one of the first two options, the resulting table in the `dm` will have all (primary as well as foreign) keys available, that could be tracked from the originally zoomed table.

## Examples

So much to the theory, but how does it look and feel?
To explore this, we once more make use of our trusted {nycflights13} data.

### Use case 1: Add a new column to an existing table

Imagine you want to have a column in `flights`, specifying if a flight left before noon or after. 
Just like with {dplyr}, we can tackle this with `mutate()`.
Let us do this step by step:

```{r zoom}
library(dm)
library(dplyr)
flights_dm <- cdm_nycflights13()
flights_dm
flights_zoomed <- 
  flights_dm %>% 
  cdm_zoom_to_tbl(flights)
# The print output for a `zoomed_dm` looks very much like that from a normal `tibble`.
flights_zoomed

flights_zoomed_mutate <- 
  flights_zoomed %>% 
  mutate(am_pm_dep = if_else(dep_time < 1200, "am", "pm")) %>% 
  # in order to see the change we use `select()` for reordering the columns
  select(year:dep_time, am_pm_dep, everything())
flights_zoomed_mutate

# In order to update the original `dm` with a new `flights` table we use `cdm_update_zoomed_tbl()`:
updated_flights_dm <- 
  flights_zoomed_mutate %>% 
  cdm_update_zoomed_tbl()
# The only difference in the `dm` print output is the increased number of columns
updated_flights_dm
# The schematic view of the data model remains unchanged
cdm_draw(updated_flights_dm)
```

### Use case 2: Creation of a surrogate key

Exactly such a course of action could for example be employed to create a surrogate key for a table.
We can do this for the `weather` table.

```{r}
library(tidyr)
weather_zoomed <- 
  flights_dm %>% 
  cdm_zoom_to_tbl(weather)
weather_zoomed
# Maybe there is some hidden candidate for a primary key that we overlooked
enum_pk_candidates(weather_zoomed)
# Seems we have to construct a column with unique values
# This can be done by combining columns `origin` with `time_hour`, if the latter 
# is converted to a single time zone first; all within the `dm`:
weather_zoomed_mutate <- 
  weather_zoomed %>% 
  # first convert all times to the same time zone:
  mutate(time_hour_fmt = format(time_hour, tz = "UTC")) %>% 
  # paste together as character the airport code and the time
  unite("origin_slot_id", origin, time_hour_fmt) %>% 
  select(origin_slot_id, everything())
# check if we the result is as expected:
enum_pk_candidates(weather_zoomed_mutate) %>% filter(candidate)
flights_upd_weather_dm <- 
  weather_zoomed_mutate %>% 
  cdm_update_zoomed_tbl() %>% 
  cdm_add_pk(weather, origin_slot_id)
flights_upd_weather_dm
# creating the coveted FK relation between `flights` and `weather`
extended_flights_dm <- 
  flights_upd_weather_dm %>% 
  cdm_zoom_to_tbl(flights) %>% 
  mutate(time_hour_fmt = format(time_hour, tz = "UTC")) %>% 
  # paste together as character the airport code and the time
  unite("origin_slot_id", origin, time_hour_fmt) %>% 
  cdm_update_zoomed_tbl() %>% 
  cdm_add_fk(flights, origin_slot_id, weather)
extended_flights_dm %>% cdm_draw()
```


### Use case 3: Disentangle `dm`

If you look at the `dm` created by `cdm_nycflights13(cycle = TRUE)`, you see that two columns of `flights` relate to one and the same table, `airports`.
One column stands for the departure airport and the other for the arrival airport.

```{r}
cdm_draw(cdm_nycflights13(cycle = TRUE))
```
In such cases it can be beneficial, to "disentangle" the `dm` by duplicating the referred table.
One way to do this in the {dm}-framework is as follows:
```{r}
disentangled_flights_dm <- 
  cdm_nycflights13(cycle = TRUE) %>% 
  # zooming and immediately inserting essentially creates a copy of the original table
  cdm_zoom_to_tbl(airports) %>% 
  cdm_insert_zoomed_tbl(destination) %>% 
  cdm_rename_tbl(origin = airports) %>% 
  # Key relations are also duplicated, so the wrong ones need to be removed
  cdm_rm_fk(flights, dest, origin) %>% 
  cdm_rm_fk(flights, origin, destination)
cdm_draw(disentangled_flights_dm)
```

In a future update we will provide a more convenient way to "disentangle" `dm` objects, so that the individual steps will be done automatically.

### Use case 4: Add summary table to `dm`

Here is an example for adding a summary of a table as a new table to a `dm` (FK-relations are taken care of automatically):

```{r}
dm_with_summary <- 
  flights_dm %>% 
  cdm_zoom_to_tbl(flights) %>% 
  count(origin, carrier) %>% 
  cdm_insert_zoomed_tbl(dep_carrier_count)
cdm_draw(dm_with_summary)
```
