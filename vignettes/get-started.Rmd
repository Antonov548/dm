---
title: "Getting Started"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of both the package {dm} and the class `dm` - which comes along with it - is to facilitate your life when you are dealing with data that comes in a data model schema.
An object of the `dm`-class contains all relevant information about the tables in a data model:

1. the place where the tables live (i.e., the `src`: a database (DB) or locally in your R session)
2. the tables themselves, i.e., the data
3. the meta-data from the data model: the key relations

Let's first have a brief look at how to create a `dm`-class object:

## Creating `dm`-objects:

A quite nice example for interconnected tables are those in the {nycflights13}-package.
The most straightforward way of squeezing them into a `dm`-object is:

```{r message=FALSE}
library(dm)
library(dplyr)
flights_dm <- dm(src_df(pkg = "nycflights13"))
flights_dm
```

This package follows the "tidyverse" approach of immutable objects.
Your data will never be overwritten in place.
Many verbs, used on a `dm` object, return a new `dm` object.
This also allows to compose sequences of operations using the `%>%` pipe operator.


## Handling keys of `dm`-objects {#kr}

As you can see in the "Data model" part of the output above, so far no keys are set.
We use `cdm_add_pk()` to add one:

```{r}
cdm_add_pk(flights_dm, airports, faa)
```

The foreign key (fk) relations are established in a similar way (see documentation of `cdm_add_fk()` for details) to the setting of the primary keys (pk).

The `cdm_nycflights13()` function provides a shortcut for the creation of a `dm` object containing the tables from the {nycflights13} package with all primary keys (pk) and foreign key (fk) relations set.
We will be using the `dm` object created by this function from here on.

```{r}
flights_dm_with_keys <- 
  cdm_nycflights13()
flights_dm_with_keys
```

Further functions that are helpful in organizing the keys of a `dm`-object are able to e.g. show you, which columns are set as key columns, remove key constraints, etc.
More details can be found in the documentation of the relevant functions.

## Visualizing the data model

Once you set the pk's and established fk relations, you can graphically represent your data model in the following way:

```{r}
flights_dm_with_keys  %>% 
  cdm_draw()
```

There are a few options of customizing the way, the data model is displayed, e.g. add different colors to subsets of the tables or arrange the tables in a different way.
You can find details about this in the documentation or in the vignette "Visualizing 'dm'-objects".

## Filtering a table of a `dm`-object {#filter}

Let's first explain the idea of a filter on a `dm` object:
1. You filter one table of your `dm`, just like with a normal `dplyr::filter()`-call
2. A cascade of joins is performed along the fk relations, resulting in a new `dm` containing only rows corresponding to the -- potentially -- reduced values in the key columns of the filtered table

For this to work, for the moment we do not allow cycles in the fk relations between the tables, since then -- without further definitions -- no well-defined result exists.
Up to now, a multiple reference from one table to another also counts as a "cycle" (this will be resolved in a future update), so before we can filter our {nycflights13}-`dm`, we have to first remove one of the fk relations pointing from `flights` to `airports`:

```{r}
flights_dm_with_keys %>% 
  cdm_rm_fk(flights, dest, airports) %>% 
  cdm_filter(airports, name == "John F Kennedy Intl") %>% 
  cdm_filter(airlines, carrier == "US")
```

In the "Rows" part of the print-output, you can observe the reduction in the numbers of rows for all tables (apart from the -- disconnected -- `weather` table), corresponding to  US Airways flights having started from JFK airport.

