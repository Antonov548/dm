---
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
pkgload::load_all()

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

fansi::set_knit_hooks(knitr::knit_hooks)
options(crayon.enabled = TRUE, width = 75, cli.width = 75)

knit_print.grViz <- function(x, ...) {
  x %>% 
    DiagrammeRsvg::export_svg() %>% 
    c("`````{=html}\n", ., "\n`````\n") %>% 
    knitr::asis_output()
}
```

# dm

The goal of `dm` is to provide tools for frequently required tasks when working with a set of related tables.
This package works with all data sources that provide a {dplyr} interface: local data frames, relational databases, and many more.

```{r}
library(tidyverse)
library(dm)
```


The new class `dm` is essentially a list containing all the important information about a set of related tables, its components being:

- `src` object: location of tables (database (DB), locally, ...)
- a so-called `data_model` object: meta-info about data model (keys, table & columns names, ...)
- the data: the tables itself

This package augments {dplyr}/{dbplyr} workflows:

- multiple related tables are kept in a single compound object,
- joins across multiple tables are available by stating the tables involved, no need to memoize column names or relationships

In addition, a battery of utilities is provided that helps with creating a tidy data model.

This package follows several of the "tidyverse" rules:

- `dm` objects are immutable (your data will never be overwritten in place)
- many functions used on `dm` objects are pipeable (i.e., return new `dm` objects)
- tidy evaluation is used (unquoted function parameters are supported)

A readymade `dm` object with preset keys is included in the package:
```{r}
flights_dm_with_keys <- cdm_nycflights13()
flights_dm_with_keys
```

For more information about the `dm` class and how to establish and display key constraints we would like to refer you to vignette "class 'dm' and basic operations".
<!-- FIXME: vignette missing; once there, needs to be linked -->

## Visualization

A basic graphic representation of the entity relationship model can be generated with:

```{r}
flights_dm_with_keys %>% 
  cdm_draw()
```

The different colors of the tables were assigned in `cdm_nycflights13()`. 
For how to add colors to subsets of the tables and further customization please see vignette "Visualizing 'dm' objects"
<!-- FIXME: vignette missing; once there, needs to be linked -->

## Filtering `dm` object and joining its tables {#filter}

Similar to `dplyr::filter()`, a filtering function `cdm_filter()` is available for `dm` objects.
You need to provide the `dm` object, the table whose rows you want to filter and the filter expression.
A `dm` object is returned whose tables only contain rows that are related to the reduced rows in the filtered table.
This currently only works for cycle-free relationships between the tables, since otherwise no well-defined solution can be calculated.
Thus, we need a slightly different `dm` object from before to show the functionality of `cdm_filter()`:

```{r}
cdm_nycflights13(cycle = FALSE) %>%
  cdm_get_tables() %>%
  map_int(nrow)

cdm_nycflights13(cycle = FALSE) %>% 
  cdm_filter(planes, year == 2000, manufacturer == "BOEING") %>%
  cdm_get_tables() %>%
  map_int(nrow)
```

If you want to join 2 tables of a `dm`, making use of their foreign key relation, you can use `cdm_join_tbl()`:

```{r}
cdm_nycflights13(cycle = FALSE) %>%
  cdm_join_tbl(airports, flights, join = semi_join)
```

In our `dm`, column `origin` of table `flights` points to table `airports`.
Since all `nycflights13`-flights take off from New York, only the NY airports are left after the semi-join.

## From and to DBs

In order to transfer an existing `dm` object to a DB, you just need to provide the `src` object with the connection to the target DB and the `dm` object:
```{r}
src_sqlite <- src_sqlite(":memory:", create = TRUE)
src_sqlite
flights_dm_with_keys_remote <- cdm_copy_to(src_sqlite, flights_dm_with_keys)
flights_dm_with_keys_remote
```

The key constraints from the original object are also copied to the newly created object.
With the default setting `set_key_constraints = TRUE` for `cdm_copy_to()`, key constraints are also established on the target DB.
Currently this feature is only supported for MSSQL and Postgres database management systems (DBMS).

It is also possible to automatically create a `dm` object from the permanent tables of a DB.
Again, for now just MSSQL and Postgres are supported for this feature, so the next chunk is not evaluated.
The support for other DBMS will be implemented in a future update.

```{r eval=FALSE}
src_postgres <- src_postgres()
flights_dm_from_remote <- cdm_learn_from_db(src_postgres)
```

## More information

If you would like to learn more about the possibilities of {dm}, please see the function documentation or the vignettes:

- Getting started
- Class 'dm' and basic operations
- Visualizing 'dm' objects
- Filtering
- {dm} and databases
- shiny with {dynafilter}
- Tips and tricks
<!-- FIXME: vignettes missing; once there, needs to be linked -->

## Installation

You can receive the package as a file `dm.tar.gz` from
Kirill Müller, Email: <kirill@cynkra.com> .
<!-- FIXME: almost outdated, needs to be github-link  -->

One way to install it to your R-Library is by opening R-Studio and
selecting “Install Packages…” from the `Tools` menu. In the appearing
window, choose the option “Install from: Package Archive File (.tgz;
.tar.gz)” and browse to `dm.tar.gz`.

---

FIXME: funder, copyright holder, code of conduct
